# DAFNI CLI documentation

## Installation

The current method of distribution is via an executable program that can be run on the command line. This will take the form of a executable file called `dafni.exe`.
Due to this, there is no installation at this stage from a user perspective, just a necessity to have a copy of the executable on the computer it is to be used on.

A pip package has also been produced on pypi: <INSERT LINK HERE> 
This can be installed in the usual way and then called by using `dafni [command]`. 
___

## Commands

There are several commands implemented for the dafni CLI, these are listed below with there associated sub-commands and options.
___
### Login

>Command: `dafni(.exe) login`

This command, when completed will store the login JWT generated by the DAFNI API to the current working directory as `dafni_jwt.txt`.
When the login process is called, the initial step is to check the current working directory for a cached JWT file, if this isn't found then a prompt will be raised for the users user name and password to generate a new JWT token.
If however there is a stored JWT file found, the expiry datetime associated with the JWT will be checked to ensure it is still valid.
If the token has not expired, then this will be used for any subsequent API calls, and prompts will not be required for the user's username and password.
Otherwise, the process to generate a new JWT will be started, and the current JWT file overwritten.

___
### Logout

>Command: `dafni(.exe) logout`

This command is used to remove any stored JWT files associated with the current users login session.
If a JWT file exists, it will be removed and the users name and id will be printed to the command line for information.
Otherwise a message informing the user that they are already logged out will be displayed.
___
### Get

>Command: `dafni(.exe) get [sub-command]`

Retrieve and display entities available to the user.
If there is no valid JWT, the user will be prompted to login before the command is carried out.

**Sub-Commands:**
- Models:
  >*Command: `dafni(.exe) get models [options]`*

  Lists the models available to the user. 

  *Options*:
  - **--creation-date**: Filter to only show the models created since a given date with format DD/MM/YYYY.
  - **--publication-date**:  Filter to only show the models created since a given date with format DD/MM/YYYY.
  - **--long/--short (-l/-s)**: If `--long/-l` added as an option, the description of each model will be returned as well as the regular information.
    If `--short/-s` is chosen, only the name, version ID, creation date and summary will be displayed.
    Default: `--short`.
  - **--json/--pretty (-j/-p)**: If `--json/-j` option chosen, the raw json of each unfiltered model is printed in a list.
    If `--pretty/-p` is chosen, model details in the format of the example output below are printed.
    Default: `--pretty`.
  
  Example output:
  <pre>
  Name: Model 1     ID: abc10-ab20-3abc-12345678a1b2      Date: January 1st 2020
  Summary: This is a summary of the model.
  
  Name: Model 2     ID: xyz10-xy20-3xyz-12345678x1y2      Date: January 1st 2020
  Summary: This is a summary of another model.
  </pre>
  With `--long`:
  <pre>
  Name: Model 1     ID: abc10-ab20-3abc-12345678a1b2      Date: January 1st 2020
  Summary: This is a summary of the model.
  Description:
  This is a longer description of the model, perhaps touching on more details 
  and other things. It uses text wrapping to be more readable.
  
  Name: Model 2     ID: xyz10-xy20-3xyz-12345678x1y2      Date: January 1st 2020
  Summary: This is a summary of another model.
  Description:
  This is a longer description of the other model, perhaps touching on more details 
  and other things. It uses text wrapping to be more readable.
  </pre>

- Model:
  >*Command: `dafni(.exe) get model [version_id] [options]`*
  
  Displays the metadata or version history for one or more model(s).
  
  *Arguments*:
  - **version_id**: Version of the model to display the metadata of.
  Multiple version IDs can be specified, and the metadata/version history of each model will be displayed in sequence.
  
  *Options*:
  - **--version-history/--metadata (-v/-m)**: If `--version-history/-v` is added as an option, the name, version ID, publication date and version message of each version of the model will be displayed in reverse chronological order.
    If `--metadata/-m` is chosen, the metadata for the version(s) of the model(s) is displayed.
    Default: `--metadata`.
  - **--json/--pretty (-j/-p)**: If `--json/-j` option chosen, the raw json of each model metadata/version history is printed, depending on the `--version-history/--metadata` option.
    If `--pretty/-p` is chosen, the metadata/version history for each model is printed in the format of the examples below.
    Default: `--pretty`.
  
  Example outputs:
  <pre>
  Name: Model 1
  Date: January 1st 2020
  Summary:
  This is a summary of the model.
  Description:
  This is a longer description of the model, perhaps touching on more details 
  and other things. It uses text wrapping to be more readable.
  
  Input Parameters:
  Title       Type       Min    Max    Default  Description
  --------------------------------------------------------------------
  param1      integer    1      10     1        A fancy parameter
  param2      string                   normal   A fancy setting
  
  Input Data Slots:
  Name: Input file
  Path in container: inputs/
  Required: True
  Default Datasets:
  Name: Dataset 1    ID: xyz09-xy09-8xyz-87654321x9y8   Version ID: xyz09-xy09-8xyz-56843975x9y8
  
  Outputs:
  Name                                     Format    Summary
  a_very_big_table_of_results.csv          CSV       The results you care about
  another_very_big_table_of_results.csv    CSV       Some extra results you may find useful
  </pre>
  
  With `--version-history`.
  <pre>
  Name: New Model 1     ID: abc10-ab20-3abc-12345678a1b2     Date: January 1st 2020
  Version message: New version
  Version tags: latest, new parameter
  
  Name: Model 1     ID: aaa10-ab20-3abc-12345678a1b2     Date: December 31st 2019
  Version message: Original version
  Version tags: 
  </pre>

- Datasets:
  >*Command: `dafni(.exe) get datasets [options]`*

  Lists the datasets available to the user. 
  
  *Note*: If a date range filter is applied, the default behavior is to omit any datasets that don't have a date range set.
  This is in part due to a bug with the discovery api (https://github.com/dafnifacility/user-feedback/issues/72) which means we can't use this filter without a search term.
  
  *Options*:
  - **--search**: Option to apply a text search to the available datasets.
  - **--start-date**:  Filter to only show the datasets with a date range since a given date with format DD/MM/YYYY.
  - **--end-date**: Filter to only show the datasets with a date range before a given date with format DD/MM/YYYY.
  - **--json/--pretty**: If `--json/-j` option chosen, the raw json returned from the API, after the filters are applied, is returned.
    If `--pretty/-p` option chosen, information for each available dataset is printed in the format of the examples below.
    Default: `--pretty`.
    
  Example output:
  <pre>
  Title: Example Dataset
  ID: xyz09-xy09-8xyz-87654321x9y8
  Latest Version: xyz09-xy09-8xyz-56843975x9y8
  Publisher: DAFNI
  From: March 27 2011    To: March 27 2021
  Description:
  Verbose description of the dataset
  </pre>

- Dataset:
  >*Command: `dafni(.exe) get dataset [dataset_id] [version_id] [options]`*

  Lists the datasets available to the user. 
  
  *Note*: If a date range filter is applied, the default behavior is to omit any datasets that don't have a date range set. This is in part due to a bug with the discovery api (https://github.com/dafnifacility/user-feedback/issues/72) which means we can't use this filter without a search term.
  
  *Arguments*:
  - **id**: Dataset ID
  - **version-id**: Dataset Version ID

  *Options*:
  - **--long**/**-l**: This prints out the additional Metadata fields: Themes, Publisher, Issued date, Rights, Language, Standards, & update frequency
  - **--version-history/--metadata (-v/-m)**: If `--version-history`/`-v` is added as an option, the Title, ID, Version ID, Publisher, Date Range
    and Description of each version of the Dataset will be displayed in reverse chronological order.
    If `--metadata`/`-m` is chosen, the metadata for that version of the model is displayed.
    Default: `--metadata`.
  - **--json/--pretty (-j/-p)**: If `--json/-j` is chosen, the raw json for the dataset metadata/version history is printed, depending on the `--version-history/--metadata` option.
    If `--pretty/-p` chosen, the metadata/version history is printed in the formats below.
    Default: `--pretty`.

  Example output:
  <pre>
  Created: March 04 2021
  Creator: DAFNI
  Contact: contact@stfc.ac.uk
  Description:
  Dataset description.
  Identifier: [id1]
  Location: England
  Start date: March 13 2010
  End date: March 14 2020
  Key Words:
  ['Arc', 'UDM', 'Visualisation']
  
  Data Files
  Name             Size       Format
  arc-outline.csv  737.3 KB   CSV
  </pre>
  *With --long option*
  <pre>
  Themes:
  [Population distribution and demography, Utility and governmental services, Statistical units]
  Publisher: DAFNI
  Issued: March 04 2021
  Rights:
  Open Government Licence.
  Language: en
  Standard: ISO 9001
  Update Frequency: Annually
  </pre>
  *With --version-history option*
  <pre>
  Title: An example workflow definition - new version
  ID: 3469587b-c7c1-4686-bd4a-0c6a2c4cc34c
  Version ID: a6360df5-ffb0-4d39-b1a0-0f8b5d8d7fa4
  Publisher: DAFNI
  From: March 01 2001    To: March 01 2020
  Description:
  Also fulling in the standard and update frequency fields.
  Adding a new version
  
  Title: An example workflow definition
  ID: 3469587b-c7c1-4686-bd4a-0c6a2c4cc34c
  Version ID: a26983da-644f-4930-8d5a-06193240d7fe
  Publisher: DAFNI
  From: March 01 2001    To: March 01 2020
  Description:
  Also fulling in the standard and update frequency fields.
  </pre>
___
### Upload

>Command: `dafni(.exe) upload [sub-command]`

Upload an entity to DAFNI.
If there is no valid JWT, the user will be prompted to login before the command is carried out.

**Sub-Commands:**
- Model:
  >*Command: `dafni(.exe) upload model [definition] [image] [options]`*
  
  Uploads a model version to DAFNI.
  
  *Arguments*:
  - **definition**: File path to the model definition file.
  - **image**: File path to the Docker image for the model.
  Information about how these files are created, and the format they should be in can be found here: https://facility.secure.dafni.rl.ac.uk/models/add/
  
  *Options*:
  - **--version-message (-m)**: Message to be added with this model version.
  This is a **required** option.
  - **--parent-model**: If the model version is an updated version of a previous DAFNI model, the parent ID of the model should be specified through this option.
    
  Example output:
  <pre>
  Model definition file path: path\to\model-definition
  Image file path: path\to\docker-image
  Version message: Model version message
  No parent model: new model to be created
  Confirm model upload? [y/N]:
  </pre>
  With parent model:
  <pre>
  Model definition file path: path\to\model-definition
  Image file path: path\to\docker-image
  Version message: Model version message
  Parent model ID: 0000aa0a-0000-0000-0000-a00aaa000aa0
  Confirm model upload? [y/N]:
  </pre>
  After confirmation:
  <pre>
  Validating model definition
  Getting urls
  Uploading model definition and image
  Ingesting model
  Model upload complete
  </pre>

  **Sub-Commands:**
- Dataset:
  >*Command: `dafni(.exe) upload dataset [definition] files `*
  
  Uploads a model version to DAFNI.
  
  *Arguments*:
  - **definition**: File path to the Dataset definition file. See https://github.com/dafnifacility/metadata-schema for details.
  - **files**: List of File paths to each associated file for the Dataset.
  
  Example output:
  <pre>
  Dataset definition file path: path\to\metadata.json
  Dataset file path: path\to\data_file_1.txt
  Dataset file path: path\to\data_file_2.txt
  Confirm Dataset upload? [y/N]: y
  </pre>
  </pre>
  After confirmation:
  <pre>
  Retrieving Temporary Upload ID
  Retrieving File Upload URls
  Uploading Dataset Files
  Uploading Dataset Metadata
  
  Upload Successful
  Dataset ID: b291fee4-8608-49af-96d4-0ca89452b0c8
  Version ID: 0a1be81b-d70a-4f05-91a2-1587fc7129b6
  Metadata ID: ee1b09b7-b4b7-4843-b14d-c5ab8aaa974d
  </pre>

___
### Delete

>Command: `dafni(.exe) delete [sub-command]`

Delete an entity to DAFNI.
If there is no valid JWT, the user will be prompted to login before the command is carried out.

**Sub-Commands:**
- Model:
  >*Command: `dafni(.exe) delete model [version-id]`*
  
  Deletes one or more model version(s) from DAFNI.
  
  *Arguments*:
  - **version-id**: Version id(s) of the model version(s) to be deleted.
  If the user does not have the necessary permissions to delete the model version, the model details will be printed, 
  the user will be notified, and the action will be aborted.
  
  Example output:
  <pre>
  ID: f2a30e94-5576-46a5-b4e5-88193d494fcd    Name: Hello World    Publication date: March 24 2021    Version message: Testing pip package with parent model
  Confirm deletion of models? [y/N]:
  </pre>
  After confirmation:
  <pre>
  Model versions deleted
  </pre>

___
### Download

>Command: `dafni(.exe) download [sub-command]`

Download an entity from DAFNI.
If there is no valid JWT, the user will be prompted to login before the command is carried out.

**Sub-Commands:**
- Dataset:
  >*Command: `dafni(.exe) download dataset [dataset_id] [version_id] [options]`*
  
  Downloads a dataset version from DAFNI.
  
  *Arguments*:
  - **dataset_id**: The Dataset ID.
  - **version_id**: The Dataset version ID.
  
  *Options*:
  - **--directory**: This defines the directory where the files will be downloaded to. Default is current working directory.

  Example output:
  <pre>
  The dataset files have been downloaded to:
  {directory}\Dataset_5a65bd64-1643-4b6e-9e43-c1d246559337_736e6b3e-a552-4d96-ab9e-f697388158c7.zip
  
  Data Files
  Name                                 Size       Format
  Domain_DEM.ASC                       420 B      Text
  Rainfall_Data_1.txt                  91 B       Text
  CityCat_Config_1.txt                 1.3 KB     Text
  CityCat_Log.txt                      36.3 KB    Text
  R1C1_SurfaceMaps.zip                 2.1 KB     ZIP
  R1C1_SurfaceMaps/R1_C1_T0_0min.rsl   691 B
  R1C1_SurfaceMaps/R1_C1_T1_10min.rsl  701 B
  R1C1_SurfaceMaps/R1_C1_T2_20min.rsl  703 B
  R1C1_SurfaceMaps/R1_C1_T3_30min.rsl  705 B
  R1C1_SurfaceMaps/R1_C1_T4_40min.rsl  705 B
  R1C1_SurfaceMaps/R1_C1_T5_50min.rsl  705 B
  R1C1_SurfaceMaps/R1_C1_T6_60min.rsl  705 B
  R1C1_SurfaceMaps/R1_C1_max_depth.csv 481 B      CSV
</pre>